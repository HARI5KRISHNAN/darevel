---
# Ansible Playbook: Jenkins Permission Management
# Manages user permissions in Jenkins CI/CD platform

- name: Manage Jenkins User Permissions
  hosts: jenkins
  become: yes
  gather_facts: yes
  vars:
    user: "{{ user | default('') }}"
    access: "{{ access | default('read') }}"
    jenkins_cli: "/var/lib/jenkins/jenkins-cli.jar"
    jenkins_url: "http://localhost:8080"
    jenkins_admin_user: "{{ lookup('env', 'JENKINS_ADMIN_USER') | default('admin', true) }}"
    jenkins_admin_token: "{{ lookup('env', 'JENKINS_ADMIN_TOKEN') | default('', true) }}"

  tasks:
    - name: Validate required parameters
      fail:
        msg: "User parameter is required"
      when: user == ''

    - name: Display permission update details
      debug:
        msg: "Setting {{ access }} access for user {{ user }} on Jenkins"

    - name: Check if Jenkins CLI exists
      stat:
        path: "{{ jenkins_cli }}"
      register: jenkins_cli_check
      ignore_errors: yes

    - name: Download Jenkins CLI if not present
      get_url:
        url: "{{ jenkins_url }}/jnlpJars/jenkins-cli.jar"
        dest: "{{ jenkins_cli }}"
        mode: '0644'
      when: not jenkins_cli_check.stat.exists
      ignore_errors: yes

    - name: Create Jenkins user if not exists
      shell: |
        java -jar {{ jenkins_cli }} -s {{ jenkins_url }} -auth {{ jenkins_admin_user }}:{{ jenkins_admin_token }} \
        create-user {{ user }} --password-stdin <<< "changeme123"
      register: create_user_result
      ignore_errors: yes
      no_log: true

    - name: Grant read permissions
      shell: |
        java -jar {{ jenkins_cli }} -s {{ jenkins_url }} -auth {{ jenkins_admin_user }}:{{ jenkins_admin_token }} \
        add-job-to-view {{ user }} all
      when: access == 'read'
      ignore_errors: yes
      register: read_result

    - name: Grant write permissions (build jobs)
      shell: |
        java -jar {{ jenkins_cli }} -s {{ jenkins_url }} -auth {{ jenkins_admin_user }}:{{ jenkins_admin_token }} \
        groovy = <<EOF
        import jenkins.model.Jenkins
        import hudson.security.*
        def instance = Jenkins.getInstance()
        def strategy = instance.getAuthorizationStrategy()
        strategy.add(hudson.model.Item.BUILD, "{{ user }}")
        strategy.add(hudson.model.Item.CONFIGURE, "{{ user }}")
        instance.save()
        EOF
      when: access == 'write'
      ignore_errors: yes
      register: write_result

    - name: Grant execute permissions (admin rights)
      shell: |
        java -jar {{ jenkins_cli }} -s {{ jenkins_url }} -auth {{ jenkins_admin_user }}:{{ jenkins_admin_token }} \
        groovy = <<EOF
        import jenkins.model.Jenkins
        import hudson.security.*
        def instance = Jenkins.getInstance()
        def strategy = instance.getAuthorizationStrategy()
        strategy.add(Jenkins.ADMINISTER, "{{ user }}")
        instance.save()
        EOF
      when: access == 'execute'
      ignore_errors: yes
      register: execute_result

    - name: Display result
      debug:
        msg: "âœ… Successfully applied {{ access }} permissions for {{ user }} on Jenkins"

    - name: Log permission change
      lineinfile:
        path: /var/log/whooper-permissions.log
        line: "{{ ansible_date_time.iso8601 }} - Jenkins: {{ user }} granted {{ access }} access"
        create: yes
      ignore_errors: yes
