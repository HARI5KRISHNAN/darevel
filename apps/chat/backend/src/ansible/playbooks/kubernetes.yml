---
# Ansible Playbook: Kubernetes Permission Management
# Manages RBAC permissions for users in Kubernetes cluster

- name: Manage Kubernetes User Permissions
  hosts: kubernetes
  become: yes
  gather_facts: yes
  vars:
    user: "{{ user | default('') }}"
    access: "{{ access | default('read') }}"
    namespace: "{{ namespace | default('default') }}"

  tasks:
    - name: Validate required parameters
      fail:
        msg: "User parameter is required"
      when: user == ''

    - name: Display permission update details
      debug:
        msg: "Setting {{ access }} access for user {{ user }} in namespace {{ namespace }}"

    - name: Create read-only Role (read access)
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: rbac.authorization.k8s.io/v1
          kind: Role
          metadata:
            name: "{{ user }}-reader"
            namespace: "{{ namespace }}"
          rules:
            - apiGroups: ["", "apps", "batch"]
              resources: ["pods", "deployments", "services", "jobs", "configmaps", "secrets"]
              verbs: ["get", "list", "watch"]
            - apiGroups: [""]
              resources: ["pods/log"]
              verbs: ["get", "list"]
      when: access == 'read'

    - name: Create editor Role (write access)
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: rbac.authorization.k8s.io/v1
          kind: Role
          metadata:
            name: "{{ user }}-editor"
            namespace: "{{ namespace }}"
          rules:
            - apiGroups: ["", "apps", "batch"]
              resources: ["pods", "deployments", "services", "jobs", "configmaps", "secrets"]
              verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
            - apiGroups: [""]
              resources: ["pods/log"]
              verbs: ["get", "list"]
            - apiGroups: [""]
              resources: ["pods/exec"]
              verbs: ["create"]
      when: access == 'write'

    - name: Create admin ClusterRole (execute access)
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRole
          metadata:
            name: "{{ user }}-admin"
          rules:
            - apiGroups: ["*"]
              resources: ["*"]
              verbs: ["*"]
      when: access == 'execute'

    - name: Create RoleBinding for read access
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: rbac.authorization.k8s.io/v1
          kind: RoleBinding
          metadata:
            name: "{{ user }}-reader-binding"
            namespace: "{{ namespace }}"
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: Role
            name: "{{ user }}-reader"
          subjects:
            - kind: User
              name: "{{ user }}"
              apiGroup: rbac.authorization.k8s.io
      when: access == 'read'

    - name: Create RoleBinding for write access
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: rbac.authorization.k8s.io/v1
          kind: RoleBinding
          metadata:
            name: "{{ user }}-editor-binding"
            namespace: "{{ namespace }}"
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: Role
            name: "{{ user }}-editor"
          subjects:
            - kind: User
              name: "{{ user }}"
              apiGroup: rbac.authorization.k8s.io
      when: access == 'write'

    - name: Create ClusterRoleBinding for execute access
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: "{{ user }}-admin-binding"
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: "{{ user }}-admin"
          subjects:
            - kind: User
              name: "{{ user }}"
              apiGroup: rbac.authorization.k8s.io
      when: access == 'execute'

    - name: Generate kubeconfig for user
      shell: |
        kubectl config set-credentials {{ user }} --token=$(kubectl create token {{ user }}-serviceaccount -n {{ namespace }} 2>/dev/null || echo "token-placeholder")
        kubectl config set-context {{ user }}-context --cluster=kubernetes --namespace={{ namespace }} --user={{ user }}
      register: kubeconfig_result
      ignore_errors: yes

    - name: Display result
      debug:
        msg: "âœ… Successfully applied {{ access }} permissions for {{ user }} in namespace {{ namespace }}"

    - name: Log permission change
      lineinfile:
        path: /var/log/whooper-permissions.log
        line: "{{ ansible_date_time.iso8601 }} - Kubernetes: {{ user }} granted {{ access }} access in {{ namespace }}"
        create: yes
      delegate_to: localhost
      ignore_errors: yes
