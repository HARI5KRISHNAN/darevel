version: '3.8'

services:
  # Jitsi Web
  jitsi-web:
    image: jitsi/web:stable-9111
    restart: unless-stopped
    ports:
      - '8000:80'
    volumes:
      - ./config/web:/config:Z
      - ./transcripts:/usr/share/jitsi-meet/transcripts:Z
    environment:
      # JWT Authentication
      - ENABLE_AUTH=1
      - AUTH_TYPE=jwt
      - JWT_APP_ID=darevel
      - JWT_APP_SECRET=darevel_jitsi_secret_key_2024_secure_256bit_min
      - JWT_ACCEPTED_ISSUERS=darevel
      - JWT_ACCEPTED_AUDIENCES=darevel
      - ENABLE_GUESTS=0
      - TOKEN_AUTH_URL=http://localhost:8081/api/jitsi/token?room={room}
      # Public URL
      - PUBLIC_URL=http://localhost:8000
      # XMPP Configuration
      - XMPP_DOMAIN=meet.jitsi
      - XMPP_AUTH_DOMAIN=auth.meet.jitsi
      - XMPP_BOSH_URL_BASE=http://xmpp.meet.jitsi:5280
      - XMPP_MUC_DOMAIN=muc.meet.jitsi
      - XMPP_INTERNAL_MUC_DOMAIN=internal-muc.meet.jitsi
      - TZ=UTC
      - JICOFO_AUTH_USER=focus
      - ENABLE_LOBBY=0
      - ENABLE_PREJOIN_PAGE=0
      - DISABLE_DEEP_LINKING=true
      - ENABLE_XMPP_WEBSOCKET=0
      - ENABLE_COLIBRI_WEBSOCKET=0
    networks:
      meet.jitsi:

  # Prosody XMPP Server
  prosody:
    image: jitsi/prosody:stable-9111
    restart: unless-stopped
    expose:
      - '5222'
      - '5347'
      - '5280'
    volumes:
      - ./config/prosody/config:/config:Z
    environment:
      # JWT Authentication
      - ENABLE_AUTH=1
      - AUTH_TYPE=jwt
      - JWT_APP_ID=darevel
      - JWT_APP_SECRET=darevel_jitsi_secret_key_2024_secure_256bit_min
      - JWT_ACCEPTED_ISSUERS=darevel
      - JWT_ACCEPTED_AUDIENCES=darevel
      - JWT_ALLOW_EMPTY=0
      - ENABLE_GUESTS=0
      # XMPP Configuration
      - XMPP_DOMAIN=meet.jitsi
      - XMPP_AUTH_DOMAIN=auth.meet.jitsi
      - XMPP_MUC_DOMAIN=muc.meet.jitsi
      - XMPP_INTERNAL_MUC_DOMAIN=internal-muc.meet.jitsi
      - JICOFO_AUTH_USER=focus
      - JICOFO_AUTH_PASSWORD=s3cr3t
      - JICOFO_COMPONENT_SECRET=s3cr3t
      - JVB_AUTH_USER=jvb
      - JVB_AUTH_PASSWORD=s3cr3t
      - TZ=UTC
      - ENABLE_XMPP_WEBSOCKET=0
    networks:
      meet.jitsi:
        aliases:
          - xmpp.meet.jitsi

  # Jicofo (Conference Focus)
  jicofo:
    image: jitsi/jicofo:stable-9111
    restart: unless-stopped
    depends_on:
      - prosody
    volumes:
      - ./config/jicofo:/config:Z
    environment:
      # JWT Authentication
      - ENABLE_AUTH=1
      - AUTH_TYPE=jwt
      - JWT_APP_ID=darevel
      - JWT_APP_SECRET=darevel_jitsi_secret_key_2024_secure_256bit_min
      # XMPP Configuration
      - XMPP_DOMAIN=meet.jitsi
      - XMPP_AUTH_DOMAIN=auth.meet.jitsi
      - XMPP_MUC_DOMAIN=muc.meet.jitsi
      - XMPP_INTERNAL_MUC_DOMAIN=internal-muc.meet.jitsi
      - XMPP_SERVER=xmpp.meet.jitsi
      - JICOFO_AUTH_USER=focus
      - JICOFO_AUTH_PASSWORD=s3cr3t
      - JICOFO_COMPONENT_SECRET=s3cr3t
      - TZ=UTC
    networks:
      meet.jitsi:

  # JVB (Jitsi Videobridge)
  jvb:
    image: jitsi/jvb:stable-9111
    restart: unless-stopped
    depends_on:
      - prosody
    ports:
      - '10000:10000/udp'
    volumes:
      - ./config/jvb:/config:Z
    environment:
      - XMPP_AUTH_DOMAIN=auth.meet.jitsi
      - XMPP_INTERNAL_MUC_DOMAIN=internal-muc.meet.jitsi
      - XMPP_SERVER=xmpp.meet.jitsi
      - JVB_AUTH_USER=jvb
      - JVB_AUTH_PASSWORD=s3cr3t
      - JVB_STUN_SERVERS=stun.l.google.com:19302
      - TZ=UTC
      - ENABLE_COLIBRI_WEBSOCKET=0
    networks:
      meet.jitsi:

networks:
  meet.jitsi:
