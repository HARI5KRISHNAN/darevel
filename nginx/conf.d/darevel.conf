# ==========================================================
# ðŸš€ Darevel Nginx Reverse Proxy (Dev Setup)
# ==========================================================

# Map subdomains to their local dev ports
map $host $port {
  default 3000;
  auth.darevel.local    3005;
  suite.darevel.local   3002;
  chat.darevel.local    3003;
  excel.darevel.local   3004;
  drive.darevel.local   3006;
  notify.darevel.local  3007;
  mail.darevel.local    3008;
  slides.darevel.local  3000;
}

# ----------------------------------------------------------
# Frontend apps (running on host machine)
# ----------------------------------------------------------
server {
  listen 80;
  server_name ~^(?<subdomain>auth|suite|chat|excel|drive|notify|mail|slides)\.darevel\.local$;

  # Log for debugging
  access_log /var/log/nginx/darevel_access.log;
  error_log  /var/log/nginx/darevel_error.log;

  location / {
    # Forward requests to the corresponding local dev server
    proxy_pass http://host.docker.internal:$port;

    # Preserve headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # WebSocket support for Next.js HMR
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_cache_bypass $http_upgrade;

    # Disable buffering for dev hot reload
    proxy_buffering off;
  }

  # WebSocket support for Next.js HMR
  location /_next/webpack-hmr {
    proxy_pass http://host.docker.internal:$port;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
  }

  # Optional: health check endpoint
  location = /health {
    return 200 'OK';
    add_header Content-Type text/plain;
  }
}

# ----------------------------------------------------------
# Keycloak (running in Docker container)
# ----------------------------------------------------------
server {
  listen 80;
  server_name keycloak.darevel.local;

  access_log /var/log/nginx/keycloak_access.log;
  error_log  /var/log/nginx/keycloak_error.log;

  location / {
    # Keycloak runs in Docker, so use service name
    proxy_pass http://keycloak:8080;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header Connection "";
    proxy_buffering off;
  }
}

# ----------------------------------------------------------
# Fallback root domain
# ----------------------------------------------------------
server {
  listen 80;
  server_name darevel.local;
  return 302 http://suite.darevel.local;
}

# ----------------------------------------------------------
# Default catch-all (security)
# ----------------------------------------------------------
server {
  listen 80 default_server;
  server_name _;
  return 404;
}
