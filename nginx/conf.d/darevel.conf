# ===========================================
# üöÄ Darevel Enterprise Suite - Nginx Proxy
# ===========================================
# This configuration fixes:
# - 502 Bad Gateway errors
# - Keycloak 1-second refresh loop
# - Proper routing for all 8 Darevel apps

# ========================
# üß≠ Darevel Suite (Main Dashboard)
# ========================
server {
  listen 80;
  server_name suite.darevel.local darevel.local;

  location / {
    proxy_pass http://host.docker.internal:3002;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_cache_bypass $http_upgrade;
  }

  # WebSocket support for Next.js HMR
  location /_next/webpack-hmr {
    proxy_pass http://host.docker.internal:3002;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
  }
}

# ========================
# üîë Auth Service
# ========================
server {
  listen 80;
  server_name auth.darevel.local;

  location / {
    proxy_pass http://host.docker.internal:3005;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_cache_bypass $http_upgrade;
  }

  location /_next/webpack-hmr {
    proxy_pass http://host.docker.internal:3005;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
  }
}

# ========================
# üîê Keycloak (SSO) - CRITICAL FIX for refresh loop
# ========================
server {
  listen 80;
  server_name keycloak.darevel.local;

  location / {
    proxy_pass http://keycloak:8080;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header Connection "";
    proxy_buffering off;
  }
}

# ========================
# üí¨ Chat Service
# ========================
server {
  listen 80;
  server_name chat.darevel.local;

  location / {
    proxy_pass http://host.docker.internal:3003;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_cache_bypass $http_upgrade;
  }

  location /_next/webpack-hmr {
    proxy_pass http://host.docker.internal:3003;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
  }
}

# ========================
# ‚òÅÔ∏è Drive Service
# ========================
server {
  listen 80;
  server_name drive.darevel.local;

  location / {
    proxy_pass http://host.docker.internal:3006;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_cache_bypass $http_upgrade;
  }

  location /_next/webpack-hmr {
    proxy_pass http://host.docker.internal:3006;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
  }
}

# ========================
# üìä Excel Service
# ========================
server {
  listen 80;
  server_name excel.darevel.local;

  location / {
    proxy_pass http://host.docker.internal:3004;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_cache_bypass $http_upgrade;
  }

  location /_next/webpack-hmr {
    proxy_pass http://host.docker.internal:3004;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
  }
}

# ========================
# üîî Notify Service
# ========================
server {
  listen 80;
  server_name notify.darevel.local;

  location / {
    proxy_pass http://host.docker.internal:3007;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_cache_bypass $http_upgrade;
  }

  location /_next/webpack-hmr {
    proxy_pass http://host.docker.internal:3007;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
  }
}

# ========================
# üìß Mail Service
# ========================
server {
  listen 80;
  server_name mail.darevel.local;

  location / {
    proxy_pass http://host.docker.internal:3008;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_cache_bypass $http_upgrade;
  }

  location /_next/webpack-hmr {
    proxy_pass http://host.docker.internal:3008;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
  }
}

# ========================
# üñº Slides Service
# ========================
server {
  listen 80;
  server_name slides.darevel.local;

  location / {
    proxy_pass http://host.docker.internal:3000;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_cache_bypass $http_upgrade;
  }

  location /_next/webpack-hmr {
    proxy_pass http://host.docker.internal:3000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
  }
}

# ========================
# üß† API Gateway (Spring Boot Microservices)
# ========================
server {
  listen 80;
  server_name api.darevel.local;

  location / {
    proxy_pass http://api-gateway:8081;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}

# ========================
# üîí Default Catch-All (Security)
# ========================
server {
  listen 80 default_server;
  server_name _;
  return 404;
}
