version: "3.9"

services:
  postgres:
    image: ${POSTGRES_IMAGE:-postgres:16}
    container_name: darevel_postgres
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak"]
      interval: 5s
      timeout: 5s
      retries: 5

  keycloak:
    image: ${KEYCLOAK_IMAGE:-quay.io/keycloak/keycloak:25.0.0}
    container_name: darevel_keycloak
    environment:
      KC_DB: postgres
      KC_DB_URL_HOST: postgres
      KC_DB_URL_PORT: 5432
      KC_DB_URL_DATABASE: keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      KC_HEALTH_ENABLED: true
      KC_METRICS_ENABLED: true
    command:
      - start-dev
      - --import-realm
    volumes:
      - ./keycloak:/opt/keycloak/data/import
    ports:
      - "${KEYCLOAK_PORT:-8080}:8080"
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/8080 && echo -e 'GET /health/ready HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3 && timeout 1 cat <&3 | grep -q 'HTTP/1.1 200' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 90s

  redis:
    image: ${REDIS_IMAGE:-redis:7}
    container_name: darevel_redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  postgres-app:
    image: ${POSTGRES_IMAGE:-postgres:16}
    container_name: darevel_postgres_app
    environment:
      POSTGRES_DB: darevel
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres_app_data:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_APP_PORT:-5433}:5432"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: darevel_backend
    environment:
      PORT: 4000
      NODE_ENV: development
      DATABASE_URL: postgresql://postgres:postgres@postgres-app:5432/darevel
      KEYCLOAK_ISSUER: http://keycloak:8080/realms/pilot180
      KEYCLOAK_JWKS_URI: http://keycloak:8080/realms/pilot180/protocol/openid-connect/certs
      CORS_ORIGINS: http://localhost:3001,http://localhost:3002,http://localhost:3003,http://localhost:3004,http://localhost:3005,http://localhost:3006,http://localhost:3007,http://localhost:3008
    volumes:
      - ./backend:/app
      - /app/node_modules
      - backend_uploads:/app/uploads
    ports:
      - "${BACKEND_PORT:-4000}:4000"
    depends_on:
      postgres-app:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    restart: unless-stopped
    command: npm run dev

  # API Gateway
  api-gateway:
    build:
      context: ./microservices
      dockerfile: api-gateway/Dockerfile
    container_name: darevel_api_gateway
    environment:
      SERVER_PORT: 8081
      KEYCLOAK_ISSUER: http://keycloak:8080/realms/pilot180
      KEYCLOAK_JWKS_URI: http://keycloak:8080/realms/pilot180/protocol/openid-connect/certs
      USER_SERVICE_URL: http://user-service:8082
      DRIVE_SERVICE_URL: http://drive-service:8083
      MAIL_SERVICE_URL: http://mail-service:8084
      CHAT_SERVICE_URL: http://chat-service:8085
      NOTIFY_SERVICE_URL: http://notify-service:8086
      EXCEL_SERVICE_URL: http://excel-service:8087
      SLIDES_SERVICE_URL: http://slides-service:8088
    ports:
      - "${API_GATEWAY_PORT:-8081}:8081"
    depends_on:
      keycloak:
        condition: service_healthy
      user-service:
        condition: service_started
      drive-service:
        condition: service_started
      mail-service:
        condition: service_started
      chat-service:
        condition: service_started
      notify-service:
        condition: service_started
      excel-service:
        condition: service_started
      slides-service:
        condition: service_started
    restart: unless-stopped

  # User Service
  user-service:
    build:
      context: ./microservices
      dockerfile: user-service/Dockerfile
    container_name: darevel_user_service
    environment:
      SERVER_PORT: 8082
      DB_HOST: postgres-app
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_NAME: darevel
      KEYCLOAK_ISSUER: http://keycloak:8080/realms/pilot180
      KEYCLOAK_JWKS_URI: http://keycloak:8080/realms/pilot180/protocol/openid-connect/certs
    ports:
      - "${USER_SERVICE_PORT:-8082}:8082"
    depends_on:
      postgres-app:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    restart: unless-stopped

  # Drive Service
  drive-service:
    build:
      context: ./microservices
      dockerfile: drive-service/Dockerfile
    container_name: darevel_drive_service
    environment:
      SERVER_PORT: 8083
      DB_HOST: postgres-app
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_NAME: darevel
      KEYCLOAK_ISSUER: http://keycloak:8080/realms/pilot180
      KEYCLOAK_JWKS_URI: http://keycloak:8080/realms/pilot180/protocol/openid-connect/certs
      UPLOAD_DIR: /app/uploads
    ports:
      - "${DRIVE_SERVICE_PORT:-8083}:8083"
    volumes:
      - drive_uploads:/app/uploads
    depends_on:
      postgres-app:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    restart: unless-stopped

  # Mail Service
  mail-service:
    build:
      context: ./microservices
      dockerfile: mail-service/Dockerfile
    container_name: darevel_mail_service
    environment:
      SERVER_PORT: 8084
      DB_HOST: postgres-app
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_NAME: darevel
      KEYCLOAK_ISSUER: http://keycloak:8080/realms/pilot180
      KEYCLOAK_JWKS_URI: http://keycloak:8080/realms/pilot180/protocol/openid-connect/certs
    ports:
      - "${MAIL_SERVICE_PORT:-8084}:8084"
    depends_on:
      postgres-app:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    restart: unless-stopped

  # Chat Service
  chat-service:
    build:
      context: ./microservices
      dockerfile: chat-service/Dockerfile
    container_name: darevel_chat_service
    environment:
      SERVER_PORT: 8085
      DB_HOST: postgres-app
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_NAME: darevel
      KEYCLOAK_ISSUER: http://keycloak:8080/realms/pilot180
      KEYCLOAK_JWKS_URI: http://keycloak:8080/realms/pilot180/protocol/openid-connect/certs
      REDIS_HOST: redis
      REDIS_PORT: 6379
    ports:
      - "${CHAT_SERVICE_PORT:-8085}:8085"
    depends_on:
      postgres-app:
        condition: service_healthy
      keycloak:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  # Notify Service
  notify-service:
    build:
      context: ./microservices
      dockerfile: notify-service/Dockerfile
    container_name: darevel_notify_service
    environment:
      SERVER_PORT: 8086
      DB_HOST: postgres-app
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_NAME: darevel
      KEYCLOAK_ISSUER: http://keycloak:8080/realms/pilot180
      KEYCLOAK_JWKS_URI: http://keycloak:8080/realms/pilot180/protocol/openid-connect/certs
      REDIS_HOST: redis
      REDIS_PORT: 6379
    ports:
      - "${NOTIFY_SERVICE_PORT:-8086}:8086"
    depends_on:
      postgres-app:
        condition: service_healthy
      keycloak:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  # Excel Service
  excel-service:
    build:
      context: ./microservices
      dockerfile: excel-service/Dockerfile
    container_name: darevel_excel_service
    environment:
      SERVER_PORT: 8087
      DB_HOST: postgres-app
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_NAME: darevel
      KEYCLOAK_ISSUER: http://keycloak:8080/realms/pilot180
      KEYCLOAK_JWKS_URI: http://keycloak:8080/realms/pilot180/protocol/openid-connect/certs
    ports:
      - "${EXCEL_SERVICE_PORT:-8087}:8087"
    depends_on:
      postgres-app:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    restart: unless-stopped

  # Slides Service
  slides-service:
    build:
      context: ./microservices
      dockerfile: slides-service/Dockerfile
    container_name: darevel_slides_service
    environment:
      SERVER_PORT: 8088
      DB_HOST: postgres-app
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_NAME: darevel
      KEYCLOAK_ISSUER: http://keycloak:8080/realms/pilot180
      KEYCLOAK_JWKS_URI: http://keycloak:8080/realms/pilot180/protocol/openid-connect/certs
    ports:
      - "${SLIDES_SERVICE_PORT:-8088}:8088"
    depends_on:
      postgres-app:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    restart: unless-stopped

volumes:
  postgres_data:
  postgres_app_data:
  backend_uploads:
  drive_uploads:
